<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Venta - FerreMax</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FontAwesome -->
    <script src="https://kit.fontawesome.com/636360e29b.js" crossorigin="anonymous"></script>

    <!-- DataTable -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.css"/>
    <script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>

    <!--  SweetAlert2  -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <!-- Estilos personalizados -->
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
<!-- Overlay para mobile -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Incluir el fragmento del sidebar pasando el parámetro currentPage -->
<div th:replace="~{fragments/sidebar :: sidebar(currentPage='ventas')}"></div>

<!-- Contenido Principal -->
<div class="main-content">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center w-100">
                <!-- Botón toggle para mobile -->
                <button class="sidebar-toggle d-lg-none" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>

                <!-- Espacio flexible -->
                <div class="flex-grow-1"></div>

                <!-- Elementos del header -->
                <div class="d-flex align-items-center gap-3">
                    <!-- Notificaciones -->
                    <div class="position-relative">
                        <button class="btn btn-link text-secondary p-2">
                            <i class="fas fa-bell fs-5"></i>
                            <span class="notification-badge"></span>
                        </button>
                    </div>

                    <!-- Usuario -->
                    <div class="d-flex align-items-center gap-2">
                        <div class="user-avatar d-flex align-items-center justify-content-center"
                             style="width: 35px; height: 35px;">
                            <img th:src="@{/images/default-user.png}"
                                 class="img-fluid rounded-circle"
                                 alt="Usuario">
                        </div>
                        <div class="d-none d-md-block">
                            <div class="fw-bold text-dark" style="font-size: 0.9rem;">Juan Administrador</div>
                            <div class="text-muted" style="font-size: 0.8rem;">Gerente General</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Content Header -->
    <div class="content-header py-4 px-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1 fw-bold text-custom-primary">Crear Nueva Venta</h2>
                <p class="text-muted mb-0">Selecciona productos y registra una nueva venta.</p>
            </div>
            <a th:href="@{/view/sale}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Volver a Ventas
            </a>
        </div>
    </div>

    <!-- Contenido del Formulario de Venta -->
    <div class="p-4">
        <div class="row g-4">
            <!-- Columna Izquierda: Carrito y Detalles de la Venta -->
            <div class="col-lg-5">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Detalles de la Venta</h5>

                        <!-- Selección de Cliente -->
                        <div class="mb-3">
                            <label for="customer" class="form-label">Cliente</label>
                            <div class="input-group">
                                <select id="customer" name="customer" class="form-select">
                                    <option th:each="c : ${customers}" th:value="${c.id_customer}" th:text="${c.name}"></option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal"
                                        data-bs-target="#addCustomerModal">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Carrito de Compras -->
                        <h6>Carrito</h6>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-sm">
                                <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cant.</th>
                                    <th>Precio</th>
                                    <th>Subtotal</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody id="cart-items">
                                <!-- Los productos se añadirán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Total -->
                        <div class="mt-3 text-end">
                            <h4>Total: <span id="total-amount">$0.00</span></h4>
                        </div>

                        <!-- Botón de Pago -->
                        <div class="d-grid mt-4">
                            <button class="btn btn-primary" id="btn-proceed-to-payment" disabled>Proceder al Pago
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Lista de Productos -->
            <div class="col-lg-7">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Productos Disponibles</h5>
                        <table id="products-table" class="table table-hover table-sm">
                            <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acción</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="p : ${products}">
                                <td th:text="${p.name}"></td>
                                <td th:text="${p.category}"></td>
                                <td th:text="${p.price}"></td>
                                <td th:text="${p.stock_quantity}"></td>
                                <td>
                                    <button class="btn btn-success btn-sm add-to-cart-btn"
                                            th:data-id="${p.id_product}"
                                            th:data-name="${p.name}"
                                            th:data-price="${p.price}"
                                            th:data-stock="${p.stock_quantity}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Añadir Cliente -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel">Añadir Nuevo Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-customer-form">
                        <div class="mb-3">
                            <label for="customer-document" class="form-label">Documento</label>
                            <input type="number" class="form-control" id="customer-document" required>
                        </div>
                        <div class="mb-3">
                            <label for="customer-name" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="customer-email" class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" id="customer-email">
                        </div>
                        <div class="mb-3">
                            <label for="customer-phone" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="customer-phone">
                        </div>
                        <div class="mb-3">
                            <label for="customer-address" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="customer-address">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" form="add-customer-form">Guardar Cliente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Realizar Pago -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Procesar Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <h2 class="fw-bold">Total a Pagar:</h2>
                        <h1 id="payment-total" class="display-4 fw-bold text-primary"></h1>
                    </div>
                    <form id="payment-form">
                        <div class="mb-3">
                            <label for="amount-paid" class="form-label">Monto Recibido (Efectivo)</label>
                            <input type="number" class="form-control form-control-lg" id="amount-paid" placeholder="0"
                                   required min="0">
                        </div>
                        <div class="text-center mt-3">
                            <h3 class="fw-bold">Cambio:</h3>
                            <h2 id="change-due" class="display-5 fw-bold text-success">$0</h2>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="confirm-sale-btn" form="payment-form">Confirmar
                        Venta
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- JavaScript Global -->
<script th:src="@{/js/script.js}"></script>
<!-- Lógica de la página -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Helper to format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Initialize DataTable
        const productsTable = new DataTable('#products-table', {
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
            }
        });

        const cart = [];
        const cartItemsContainer = document.getElementById('cart-items');
        const totalAmountSpan = document.getElementById('total-amount');
        const btnProceedToPayment = document.getElementById('btn-proceed-to-payment');
        const customerSelect = document.getElementById('customer');

        // Add to Cart
        $('#products-table tbody').on('click', '.add-to-cart-btn', function() {
            const button = $(this);
            const product = {
                id: button.data('id'),
                name: button.data('name'),
                price: parseFloat(button.data('price')),
                stock: parseInt(button.data('stock'))
            };

            const existingCartItem = cart.find(item => item.id === product.id);
            if (existingCartItem) {
                Swal.fire('Producto en Carrito', 'Este producto ya ha sido añadido. Puede modificar la cantidad o eliminarlo del carrito.', 'info');
                return;
            }

            if (product.stock <= 0) {
                Swal.fire('Sin Stock', 'Este producto no tiene stock disponible.', 'error');
                return;
            }

            Swal.fire({
                title: `Añadir ${product.name}`,
                input: 'number',
                inputLabel: `Cantidad (disponible: ${product.stock})`,
                inputValue: 1,
                showCancelButton: true,
                confirmButtonText: 'Añadir',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value || value <= 0) {
                        return 'Por favor, ingrese una cantidad válida.';
                    }
                    if (parseInt(value) > product.stock) {
                        return `La cantidad no puede superar el stock disponible (${product.stock}).`;
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const quantity = parseInt(result.value);
                    const cartItem = { ...product, quantity };
                    cart.push(cartItem);
                    renderCart();
                }
            });
        });

        // Render Cart
        function renderCart() {
            cartItemsContainer.innerHTML = '';
            let total = 0;

            cart.forEach(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                const row = `
                    <tr data-id="${item.id}">
                        <td>${item.name}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm cart-item-qty" value="${item.quantity}" min="1" max="${item.stock}" style="width: 70px;">
                        </td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${formatCurrency(subtotal)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm remove-from-cart-btn" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                cartItemsContainer.innerHTML += row;
            });

            totalAmountSpan.textContent = formatCurrency(total);
            updatePaymentButtonState();
        }

        // Handle quantity change in cart
        $('#cart-items').on('change', '.cart-item-qty', function() {
            const input = $(this);
            const productId = input.closest('tr').data('id');
            const newQuantity = parseInt(input.val());

            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                if (newQuantity > cartItem.stock) {
                    Swal.fire('Stock Insuficiente', 'No puede solicitar más de ' + cartItem.stock + ' unidades.', 'error');
                    input.val(cartItem.quantity); // revert to old quantity
                    return;
                }
                cartItem.quantity = newQuantity;
                renderCart();
            }
        });

        // Remove from Cart
        $('#cart-items').on('click', '.remove-from-cart-btn', function() {
            const button = $(this);
            const productId = button.data('id');
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                cart.splice(itemIndex, 1);
                renderCart();
            }
        });

        // Update payment button state
        function updatePaymentButtonState() {
            const customerSelected = customerSelect.value !== '';
            const cartIsNotEmpty = cart.length > 0;
            btnProceedToPayment.disabled = !customerSelected || !cartIsNotEmpty;
        }

        customerSelect.addEventListener('change', updatePaymentButtonState);

        updatePaymentButtonState(); // Initial check

        // Handle "Add Customer" modal form submission
        const addCustomerForm = document.getElementById('add-customer-form');
        const addCustomerModalEl = document.getElementById('addCustomerModal');
        const addCustomerModal = new bootstrap.Modal(addCustomerModalEl);

        addCustomerForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const customerData = {
                document: document.getElementById('customer-document').value,
                name: document.getElementById('customer-name').value,
                email: document.getElementById('customer-email').value,
                phone: document.getElementById('customer-phone').value,
                address: document.getElementById('customer-address').value
            };

            fetch('/api/customers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(customerData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al guardar el cliente');
                }
                return response.json();
            })
            .then(newCustomer => {
                const option = document.createElement('option');
                option.value = newCustomer.id;
                option.textContent = newCustomer.name;
                option.selected = true;
                customerSelect.appendChild(option);

                customerSelect.dispatchEvent(new Event('change'));

                addCustomerModal.hide();
                Swal.fire('Éxito', 'Cliente añadido correctamente.', 'success');
                addCustomerForm.reset();
            })
            .catch(error => {
                Swal.fire('Error', error.message, 'error');
            });
        });

        // --- Payment Modal Logic ---
        const paymentModalEl = document.getElementById('paymentModal');
        const paymentModal = new bootstrap.Modal(paymentModalEl);
        const paymentTotalSpan = document.getElementById('payment-total');
        const amountPaidInput = document.getElementById('amount-paid');
        const changeDueSpan = document.getElementById('change-due');
        const paymentForm = document.getElementById('payment-form');
        let currentTotal = 0;

        btnProceedToPayment.addEventListener('click', function() {
            currentTotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            paymentTotalSpan.textContent = formatCurrency(currentTotal);
            amountPaidInput.value = '';
            changeDueSpan.textContent = formatCurrency(0);
            paymentModal.show();
        });

        amountPaidInput.addEventListener('input', function() {
            const amountPaid = parseFloat(this.value) || 0;
            const change = amountPaid - currentTotal;
            changeDueSpan.textContent = formatCurrency(change > 0 ? change : 0);
        });

        paymentForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const amountPaid = parseFloat(amountPaidInput.value) || 0;
            if (amountPaid < currentTotal) {
                Swal.fire('Monto Insuficiente', 'El monto recibido no puede ser menor al total a pagar.', 'error');
                return;
            }

            const payload = {
                customerId: parseInt(customerSelect.value),
                items: cart.map(item => ({
                    productId: item.id,
                    quantity: item.quantity
                }))
            };

            const confirmBtn = document.getElementById('confirm-sale-btn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

            fetch('/api/sales', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Error al guardar la venta') });
                }
                return response.text();
            })
            .then(successMessage => {
                const change = amountPaid - currentTotal;
                Swal.fire({
                    icon: 'success',
                    title: '¡Venta Registrada!',
                    text: `${successMessage}. Cambio a devolver: ${formatCurrency(change)}`,
                    confirmButtonText: 'Aceptar'
                }).then(() => {
                    window.location.href = '/view/sale';
                });
            })
            .catch(error => {
                Swal.fire('Error', `No se pudo registrar la venta: ${error.message}`, 'error');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Confirmar Venta';
            });
        });
    });
</script>
</body>
</html>
